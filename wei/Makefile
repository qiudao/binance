.PHONY: help download-trades sync-trades ls-trades clean-trades download-wallet sync-wallet ls-wallet clean-wallet download-orders sync-orders ls-orders clean-orders analyze plot dashboard

# é»˜è®¤æ˜¾ç¤ºå¸®åŠ©
.DEFAULT_GOAL := help

help:
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "  BitMEX æ•°æ®ä¸‹è½½ä¸åˆ†æå·¥å…·"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo ""
	@echo "ğŸ“Š äº¤æ˜“è®°å½• (Trades)"
	@echo "  download-trades    å…¨é‡ä¸‹è½½äº¤æ˜“è®°å½•"
	@echo "  sync-trades        å¢é‡åŒæ­¥äº¤æ˜“è®°å½•"
	@echo "  ls-trades          åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶"
	@echo "  clean-trades       æ¸…ç†æ‰€æœ‰æ–‡ä»¶ï¼ˆéœ€ç¡®è®¤ï¼‰"
	@echo ""
	@echo "ğŸ’° é’±åŒ…å†å² (Wallet)"
	@echo "  download-wallet    å…¨é‡ä¸‹è½½é’±åŒ…å†å²"
	@echo "  sync-wallet        å¢é‡åŒæ­¥é’±åŒ…å†å²"
	@echo "  ls-wallet          åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶"
	@echo "  clean-wallet       æ¸…ç†æ‰€æœ‰æ–‡ä»¶ï¼ˆéœ€ç¡®è®¤ï¼‰"
	@echo ""
	@echo "ğŸ“‹ è®¢å•è®°å½• (Orders)"
	@echo "  download-orders    å…¨é‡ä¸‹è½½è®¢å•è®°å½•"
	@echo "  sync-orders        å¢é‡åŒæ­¥è®¢å•è®°å½•"
	@echo "  ls-orders          åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶"
	@echo "  clean-orders       æ¸…ç†æ‰€æœ‰æ–‡ä»¶ï¼ˆéœ€ç¡®è®¤ï¼‰"
	@echo ""
	@echo "ğŸ“ˆ æ•°æ®åˆ†æ (Analysis)"
	@echo "  analyze            ç”Ÿæˆæ–‡æœ¬åˆ†ææŠ¥å‘Š"
	@echo "  plot               ç”ŸæˆPythonå¯è§†åŒ–å›¾è¡¨ï¼ˆéœ€å®‰è£…pandasï¼‰"
	@echo "  dashboard          ç”ŸæˆHTMLäº¤äº’å¼ä»ªè¡¨æ¿ï¼ˆéœ€å®‰è£…pandasï¼‰"
	@echo ""
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# ============================================================
# äº¤æ˜“è®°å½• (Trades)
# ============================================================

download-trades:
	@echo "ğŸ“¥ å…¨é‡ä¸‹è½½äº¤æ˜“è®°å½•..."
	@go run bitmex_data.go

sync-trades:
	@echo "ğŸ”„ å¢é‡åŒæ­¥äº¤æ˜“è®°å½•..."
	@go run bitmex_data.go --update

ls-trades:
	@echo "ğŸ“„ äº¤æ˜“è®°å½•æ–‡ä»¶:"
	@ls -lh executions.csv executions.csv.bak 2>/dev/null || echo "  (æ— æ–‡ä»¶)"

clean-trades:
	@echo "âš ï¸  è­¦å‘Š: å°†åˆ é™¤ executions.csv å’Œ executions.csv.bak"
	@read -p "ç¡®è®¤åˆ é™¤? [y/N] " ans; \
	if [ "$$ans" = "y" ] || [ "$$ans" = "Y" ]; then \
		rm -f executions.csv executions.csv.bak; \
		echo "âœ“ å·²æ¸…ç†"; \
	else \
		echo "âœ— å·²å–æ¶ˆ"; \
	fi

# ============================================================
# é’±åŒ…å†å² (Wallet)
# ============================================================

download-wallet:
	@echo "ğŸ“¥ å…¨é‡ä¸‹è½½é’±åŒ…å†å²..."
	@go run bitmex_wallet.go

sync-wallet:
	@echo "ğŸ”„ å¢é‡åŒæ­¥é’±åŒ…å†å²..."
	@go run bitmex_wallet.go --update

ls-wallet:
	@echo "ğŸ“„ é’±åŒ…å†å²æ–‡ä»¶:"
	@ls -lh wallet.csv wallet.csv.bak 2>/dev/null || echo "  (æ— æ–‡ä»¶)"

clean-wallet:
	@echo "âš ï¸  è­¦å‘Š: å°†åˆ é™¤ wallet.csv å’Œ wallet.csv.bak"
	@read -p "ç¡®è®¤åˆ é™¤? [y/N] " ans; \
	if [ "$$ans" = "y" ] || [ "$$ans" = "Y" ]; then \
		rm -f wallet.csv wallet.csv.bak; \
		echo "âœ“ å·²æ¸…ç†"; \
	else \
		echo "âœ— å·²å–æ¶ˆ"; \
	fi

# ============================================================
# è®¢å•è®°å½• (Orders)
# ============================================================

download-orders:
	@echo "ğŸ“¥ å…¨é‡ä¸‹è½½è®¢å•è®°å½•..."
	@go run bitmex_orders.go

sync-orders:
	@echo "ğŸ”„ å¢é‡åŒæ­¥è®¢å•è®°å½•..."
	@go run bitmex_orders.go --update

ls-orders:
	@echo "ğŸ“„ è®¢å•è®°å½•æ–‡ä»¶:"
	@ls -lh orders.csv orders.csv.bak 2>/dev/null || echo "  (æ— æ–‡ä»¶)"

clean-orders:
	@echo "âš ï¸  è­¦å‘Š: å°†åˆ é™¤ orders.csv å’Œ orders.csv.bak"
	@read -p "ç¡®è®¤åˆ é™¤? [y/N] " ans; \
	if [ "$$ans" = "y" ] || [ "$$ans" = "Y" ]; then \
		rm -f orders.csv orders.csv.bak; \
		echo "âœ“ å·²æ¸…ç†"; \
	else \
		echo "âœ— å·²å–æ¶ˆ"; \
	fi

# ============================================================
# æ•°æ®åˆ†æ (Analysis)
# ============================================================

analyze:
	@echo "ğŸ“Š ç”Ÿæˆé’±åŒ…èµ„é‡‘åˆ†ææŠ¥å‘Š..."
	@if [ ! -f wallet.csv ]; then \
		echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° wallet.csv"; \
		echo "è¯·å…ˆè¿è¡Œ: make download-wallet"; \
		exit 1; \
	fi
	@mkdir -p report
	@./analyze_wallet.sh | tee report/wallet_report.txt
	@echo ""
	@echo "âœ“ æŠ¥å‘Šå·²ä¿å­˜: report/wallet_report.txt"

plot:
	@echo "ğŸ“ˆ ç”ŸæˆPythonå¯è§†åŒ–å›¾è¡¨..."
	@if [ ! -f wallet.csv ]; then \
		echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° wallet.csv"; \
		echo "è¯·å…ˆè¿è¡Œ: make download-wallet"; \
		exit 1; \
	fi
	@if ! python3 -c "import pandas, matplotlib" 2>/dev/null; then \
		echo ""; \
		echo "âŒ ç¼ºå°‘ä¾èµ–: pandas æˆ– matplotlib"; \
		echo ""; \
		echo "å®‰è£…æ–¹æ³•:"; \
		echo "  sudo apt install python3-pandas python3-matplotlib"; \
		echo "  æˆ–"; \
		echo "  python3 -m pip install --user pandas matplotlib"; \
		echo ""; \
		exit 1; \
	fi
	@mkdir -p report
	@./analyze_wallet.py --save
	@echo ""
	@echo "âœ“ å›¾è¡¨å·²ä¿å­˜åˆ° report/ ç›®å½•:"
	@ls -lh report/*.png 2>/dev/null || true

dashboard:
	@echo "ğŸ“Š ç”ŸæˆHTMLäº¤äº’å¼ä»ªè¡¨æ¿..."
	@if [ ! -f wallet.csv ]; then \
		echo "âŒ é”™è¯¯: æ‰¾ä¸åˆ° wallet.csv"; \
		echo "è¯·å…ˆè¿è¡Œ: make download-wallet"; \
		exit 1; \
	fi
	@if ! python3 -c "import pandas" 2>/dev/null; then \
		echo ""; \
		echo "âŒ ç¼ºå°‘ä¾èµ–: pandas"; \
		echo ""; \
		echo "å®‰è£…æ–¹æ³•:"; \
		echo "  sudo apt install python3-pandas"; \
		echo "  æˆ–"; \
		echo "  python3 -m pip install --user pandas"; \
		echo ""; \
		exit 1; \
	fi
	@mkdir -p report
	@python3 generate_dashboard.py
	@echo ""
	@echo "âœ“ å·²ç”Ÿæˆ: report/wallet_dashboard.html"
	@echo "  åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æŸ¥çœ‹"
